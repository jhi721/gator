# Gator

A tiny CLI RSS reader/aggregator written in Go. Gator lets you:

- Register/login a local user (stored in Postgres)
- Add RSS feeds and follow/unfollow them
- Periodically aggregate feed items into a database
- Browse the most recent posts from your followed feeds

It uses PostgreSQL for persistence, `sqlc` for type-safe queries, and a small
config file in your home directory to remember the current user and DB URL.

## Requirements

- Go toolchain (1.21+ recommended)
- PostgreSQL 13+
- Optional (development): `sqlc` for regenerating DB code

## Project Layout

- `main.go` – CLI entrypoint and command registration
- `handler_*.go` – command handlers (users, feeds, follows, aggregator, browse)
- `middleware.go` – simple middleware for “logged in” commands
- `internal/config` – reads and writes `~/.gatorconfig.json`
- `internal/rss` – minimal RSS fetcher/parser
- `internal/database` – generated by `sqlc` from `sql/queries` and `sql/schema`
- `sql/schema` – PostgreSQL schema migrations (with `-- +goose` markers)
- `sql/queries` – SQL used to generate Go code via `sqlc`

## Quick Start

1. Create the database

- Create a database (example name: `gator`):
  - `createdb gator` (macOS/Linux) or run `CREATE DATABASE gator;` in `psql`.

2. Apply schema

- Easiest: run each file in `sql/schema` in order (`001_users.sql` → `005_posts.sql`). For example:

  - `psql "$DB_URL" -f sql/schema/001_users.sql`
  - `psql "$DB_URL" -f sql/schema/002_feeds.sql`
  - `psql "$DB_URL" -f sql/schema/003_feed_follows.sql`
  - `psql "$DB_URL" -f sql/schema/004_last_fetched_at.sql`
  - `psql "$DB_URL" -f sql/schema/005_posts.sql`

  The files include `-- +goose` annotations if you prefer to use `goose`, but
  using `psql` directly works fine.

3. Create the config file

Create `~/.gatorconfig.json` with your connection string. Example:

```json
{
  "db_url": "postgres://USER:PASSWORD@localhost:5432/gator?sslmode=disable",
  "current_user_name": ""
}
```

4. Build the CLI

```bash
go build -o gator
```

5. Register and log in

```bash
./gator register alice
./gator login alice
```

## Usage

- `register <username>`: Create a new user and set as current
- `login <username>`: Switch the current user
- `users`: List all users, marks the current one
- `reset`: Delete all users (feeds/follows cascade due to FK constraints)

Feeds and follows:

- `addfeed <name> <url>`: Create a feed and auto-follow it as the current user
- `feeds`: List all feeds (with creator username)
- `follow <url>`: Follow an existing feed by URL
- `following`: List feeds you follow
- `unfollow <url>`: Unfollow a feed by URL

Aggregating and browsing:

- `agg <interval>`: Continuously fetch the next feed to scrape at the given
  interval (e.g., `./gator agg 1m`, `./gator agg 30s`). Runs until Ctrl‑C.
- `browse`: Print the most recent posts (titles) in the DB

Notes:

- The aggregator picks the next feed by `last_fetched_at` (oldest/never
  fetched first) and updates it as feeds are scraped.
- The RSS client sends `User-Agent: gator` and parses common fields
  (title/link/description/pubDate).

## Configuration

`~/.gatorconfig.json` is read on startup and updated when you change users.

- `db_url`: PostgreSQL connection string, e.g.
  `postgres://USER:PASSWORD@localhost:5432/gator?sslmode=disable`
- `current_user_name`: Set by `register`/`login` and used by “logged in” commands

## Development

- Regenerate DB code with `sqlc`:
  - Install: `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`
  - Generate: `sqlc generate` (reads `sqlc.yaml`)
- Run the app:
  - `go build -o gator && ./gator <command> [args]`

## Troubleshooting

- “cannot read ~/.gatorconfig.json”: Create the file with the example content.
- “pq: relation … does not exist”: Ensure all `sql/schema/*.sql` files were applied.
- Aggregator exits immediately: Check network access and that feed URLs are valid.
